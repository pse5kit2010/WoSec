var WoSec={baseObject:{later:function(b,e){var c=this,i=Array.prototype.slice.apply(arguments,[2]);typeof e==="string"&&(e=c[e]);setTimeout(function(){e.apply(c,i)},b);return c}},inherit:function(b,e){var c=Object.create(e.prototype);c.constructor=b;b.prototype=c},extend:function(b,e){for(var c in e)e.hasOwnProperty(c)&&(b[c]=e[c]);return b}};(function(){var b=jQuery;WoSec.SVG=function(e){this.$svg=b("#"+e)}})();
(function(){function b(b,g){return b.find("svg rect").filter(function(){return c(this).attr(i)==g})}function e(b,g){return b.find("svg circle").filter(function(){return c(this).attr(i)==g})}var c=jQuery,i="bpmn:activity-id",j={};WoSec.SVG.prototype.getTaskRectangle=function(b){j[b]||(j[b]=this.newTaskRectangle(b));return j[b]};WoSec.SVG.prototype.newTaskRectangle=function(f){var g=this.$svg,d=!1,a=b(g,f);a.length||(a=e(g,f),d=!0);if(a.length==0)throw Error("No rectangles/circles with activityID:["+
f+"] found");var h=Object.create(WoSec.baseObject),k=!0;h.disableAnimations=function(){k=!1;return this};h.enableAnimations=function(){k=!0;return this};h.scrollTo=function(){var a=this.getPosition(),b=a.x-g.parent().width()/2,a=a.y-g.parent().height()/2,c=g.scrollLeft(),d=g.scrollTop();if(Math.abs(b-c)>100||Math.abs(a-d)>100)g.animate({scrollLeft:b},100),g.animate({scrollTop:a},100);return this};h.refresh=function(a){switch(a.getState()){case "Reset":this.reset();break;case "Started":this.markObtrusive();
k&&(this.scrollTo(),this.highlight());break;case "Finished":this.markUnobtrusive(),k&&this.scrollTo()}};h.getPosition=function(){if(d){var b=parseInt(c(a[0]).attr("r"));return{x:parseInt(c(a[0]).attr("cx")),y:parseInt(c(a[0]).attr("cy")),width:b*2,height:b*2,getCenter:function(){return{x:this.x,y:this.y}}}}return{x:parseInt(c(a[0]).attr("x")),y:parseInt(c(a[0]).attr("y")),width:parseInt(c(a[0]).attr("width")),height:parseInt(c(a[0]).attr("height")),getCenter:function(){return{x:this.x+this.width/
2,y:this.y+this.height/2}}}};var l=g.find("svg text").filter(function(){var a=h.getPosition();return Math.abs(parseInt(c(this).attr("x"))-a.x)<a.width&&Math.abs(parseInt(c(this).attr("y"))-a.y)<a.height});h.highlight=function(){a.each(function(){c(this).effect("pulsate",{times:3},1E3)});return this};h.markObtrusive=function(){a.each(function(){var a=c("#rect-obtrusive").css("color");c(this).attr("fill",a);c(this).css("fill",a)});return this};h.markUnobtrusive=function(){a.each(function(){var a=c("#rect-unobtrusive").css("color");
c(this).attr("fill",a);c(this).css("fill",a)});return this};h.reset=function(){a.each(function(){var a=c("#rect-reset").css("color");c(this).attr("fill",a);c(this).css("fill",a)});return this};h.registerOnClick=function(b){c(a[0]).click(b);l.each(function(){c(this).click(b)});return this};h.registerOnHover=function(b){c(a[0]).hover(b);l.each(function(){c(this).hover(b)});return this};h.getOtherWorkflowID=function(){var b;a.each(function(){var a=c(this).attr("bpmn:other-workflow");a&&(b=a)});return b};
return h}})();(function(){function b(b,i){return b.find("svg rect").filter(function(){return e(this).attr("bpmn:pool-id")==i})}var e=jQuery;WoSec.SVG.prototype.newTaskLaneRectangle=function(c){var i=b(this.$svg,c),c=Object.create(WoSec.baseObject),j=!0;c.disableAnimations=function(){j=!1;return this};c.enableAnimations=function(){j=!0;return this};c.highlight=function(){i.each(function(){e(this).effect("pulsate",{times:1},1E3)})};c.refresh=function(){j&&this.highlight()};return c}})();
(function(){var b,e,c=jQuery;b=25.5;e=33;var i;WoSec.SVG.prototype.newDataAnimation=function(j,f,g){function d(a){a.x-=b/2;a.y-=e/2;return a}var f=d(f),g=d(g),a=Object.create(WoSec.baseObject),h=this.$svg;i||(i=document.createElementNS("http://www.w3.org/2000/svg","image"),i.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","media/images/fileicon.png"),i.setAttribute("width",b),i.setAttribute("height",e));var k=i.cloneNode(!0);k.setAttribute("id",j);h.find("svg")[0].appendChild(k);var l=
c("#"+j);l.hide();l.attr("x",f.x);l.attr("y",f.y);var o=!0;a.disableAnimations=function(){o=!1;return this};a.enableAnimations=function(){o=!0;return this};a.show=function(){l.show();l.animate({svgY:g.y},1E3,function(){l.hide();l.attr("y",f.y)});return this};a.refresh=function(a){switch(a.getState()){case "TransferingData":o&&this.show()}};return a}})();
(function(){var b=jQuery,e=WoSec.SVG,c="infoboxes",i="svg",j="workflow-link",f="current-workflow",g=2E3;WoSec.HTMLGUI=function(d){function a(a){b("."+i).each(function(){b(this).hide()});p[r].hide();p[a].show();r=a;b("."+j).each(function(){b(this).removeClass(f);b(this).attr("href").substr(1)===a&&b(this).addClass(f)});b("#"+a).show();s[a].addClass(f);d.forEach(function(b){b.getWorkflow().getID()!==a&&b.lock()})}function h(d){for(var e=d.getID(),h=d.getTaskRepositoryEntries(),f,i=h.length-1;i>=0;i--)if(f=
h[i],!(n[e].indexOf(f)>-1)){var j=d.getTaskByID(f),m=l[e].newTaskRectangle(f);j.registerObserver(m);var p=m.getOtherWorkflowID();p&&j.registerObserver(function(b){return{refresh:function(c){c.getState()==="TransferingData"&&setTimeout(function(){a(b)},g)}}}(p));var q;j.getCorrespondingTask()&&(q=l[e].newDataAnimation(f,m.getPosition().getCenter(),l[e].getTaskRectangle(j.getCorrespondingTask().getID()).getPosition().getCenter()),j.registerObserver(q));f=k.newInfobox(m.getPosition());j.registerObserver(f);
m.registerOnHover(f.show);f.appendTo(b("#"+e).find("."+c));o[e].push(m);q&&o[e].push(q)}n[e]=h}var k=this,l={},o={},n={},m={},p={},q=[],r=d[0].getWorkflow().getID();this.refresh=function(a){h(a);for(var b=a.getID(),c=a.getTaskLaneRepositoryEntries(),d,e=c.length-1;e>=0;e--)if(d=c[e],!(m[b].indexOf(d)>-1)){var g=l[b].newTaskLaneRectangle(d);a.getTaskLaneByID(d).registerObserver(g);o[b].push(g)}m[b]=c;return this};d.forEach(function(a){var b=a.getWorkflow(),c=b.getID();q.push(c);p[c]=new k.TimeSlider(k,
a);p[c].appendTo("#slider");a.registerObserver(p[c]);b.registerObserver(k)});b("."+i).each(function(){var a=b(this).attr("id");if(q.indexOf(a)===-1)throw Error("Unknown workflowID["+a+"]");l[a]=new e(a);o[a]=[];n[a]=[];m[a]=[]});var s={};b("."+j).each(function(){var c=b(this).attr("href").substr(1);s[c]=b(this);if(q.indexOf(c)===-1)throw Error("Unknown workflowID["+c+"]");b(this).click(function(){a(b(this).attr("href").substr(1))})});a(d[0].getWorkflow().getID());this.disableAnimations=function(a){o[a.getWorkflow().getID()].forEach(function(a){a.disableAnimations()});
return this};this.enableAnimations=function(a){o[a.getWorkflow().getID()].forEach(function(a){a.enableAnimations()});return this};b("."+i).dragscrollable({dragSelector:".dragger:first",acceptPropagatedEvent:!0})}})();
(function(){var b=jQuery,e,c,i;WoSec.HTMLGUI.prototype.newInfobox=function(j){e||(e=b("<div class=\"infobox\"><span class='infobox-pin-button'>#</span></div>").hide());var f=e.clone(),g=!0;f.css("top",j.y+j.height);f.css("left",j.x+j.width);var d=!1,a=!1;f.find(".infobox-pin-button").click(function(){a?h.unpin():h.pin()});var h=Object.create(WoSec.baseObject);return WoSec.extend(h,{refresh:function(a){this.setContent(a.getInformation(),a)},show:function(){!d&&!g&&(f.slideToggle("slow"),d=!0,h.later(3E3,
"hide"));return this},hide:function(){d&&!a&&(f.slideToggle("slow"),d=!1);return this},pin:function(){a=!0;h.show();return this},unpin:function(){a=!1;h.hide();return this},setContent:function(a,d){f.find(".infobox-entry").remove();a.forEach(function(a){c||(c=b('<div class="infobox-entry"><span class="infobox-entry-header"><span class="infobox-entry-time"></span><span class="infobox-entry-execUser"></span></span><div class="infobox-entry-content"><span class="infobox-entry-evokUser"></span><span class="infobox-entry-provider"></span><span class="infobox-entry-data"></span><ul class="infobox-entry-attachments"></ul><span class="infobox-entry-usageReason"></span></div></div>'));
var e=c.clone(),h=new Date(a.timestamp*1E3);e.find(".infobox-entry-time").text(h.getDate()+"."+h.getMonth()+"."+h.getFullYear());a.participants&&(e.find(".infobox-entry-execUser").text(a.participants.execUser),e.find(".infobox-entry-evokUser").text(a.participants.evokUser),e.find(".infobox-entry-provider").text(a.participants.provider),g=!1);e.find(".infobox-entry-data").text(a.data);if(a.attachments){var k=e.find(".infobox-entry-attachments");a.attachments.forEach(function(a){i||(i=b('<li class="infobox-attachment-entry"><span class="infobox-attachment-entry-name"></span><a></a></li>'));
var c=i.clone();c.find(".infobox-attachment-entry-name").text(a.name);c.find("a").attr("href",a.link).text(a.type);k.append(c)});g=!1}e.find(".infobox-entry-usageReason").text(a.usageReason);a.fromTask===d.getID()&&a.fromWorkflow===d.getWorkflow().getID()?e.addClass("infobox-entry-outgoing"):e.addClass("infobox-entry-incoming");f.append(e)});return this},registerOnClick:function(a){f.click(a);return this},registerOnHover:function(a,b){f.hover(a,b);return this},appendTo:function(a){f.appendTo(a);return this}})}})();
(function(){var b=jQuery,e="timeslider-play-pause-button",c="timeslider-play-button",i="timeslider-pause-button",j,f;WoSec.HTMLGUI.prototype.TimeSlider=function(g,d){function a(){l=!0;n.find("."+e).removeClass(i).addClass(c)}function h(){var a=d.getLength()>0?d.getEventCommand(0).getTimestamp():0,b=d.last().getTimestamp();m("option","min",a);m("option","max",b);var c=b-a;k.forEach(function(a){rightPercent=(b-a.timestamp)/c*100;a.entry.css("left",100-rightPercent+"%")})}var k=[],l=!1,o=!1;j||(j=b("<div class='timeslider'></div>"));
var n=j.clone(),m=n.slider({slide:function(b,c){var e=m("option","value"),h=c.value<e,f;k.forEach(function(a){if(a.timestamp<=c.value)f=a.eventCommand});g.disableAnimations(d);a();o=!0;d.lock().seek(function(a){h?a.unwind():a.execute();if(a==f)return!1},h);o=!1}}),m=m.slider.bind(m);b("."+e).click(function(){l?(g.enableAnimations(d),l=!1,n.find("."+e).removeClass(c).addClass(i),d.unlock().play()):(d.lock(),a())});b(".timeslider-forward-button").click(function(){g.disableAnimations(d);d.seek(function(a){a.execute()});
l||g.enableAnimations(d)});b(".timeslider-backward-button").click(function(){g.disableAnimations(d);d.seek(function(a){a.unwind()},!0);l||g.enableAnimations(d)});this.refresh=function(a,c){switch(c){case "add":a.forEach(function(a,c){if(!k[c]){var d={};d.eventCommand=a;d.timestamp=a.getTimestamp();var e=n;f||(f=b('<a class="timeslider-entry"></a>'));d.entry=f.clone().appendTo(e);d.entry.addClass("timeslider-entry-"+a.getClass());k.push(d)}});h();a.isLocked()&&(n.find(".timeslider-play-pause-button-overlay").show(),
n.find("."+e).effect("pulsate",{times:10},1E3),setTimeout(function(){n.find(".timeslider-play-pause-button-overlay").hide()},1E4));break;case "position":o||m("option","value",a.getEventCommand(a.getCurrentPosition()).getTimestamp())}};this.appendTo=n.appendTo.bind(n);this.hide=n.hide.bind(n);this.show=n.show.bind(n)}})();
(function(){WoSec.MixinObservable=function(){var b=[];this.registerObserver=function(e){if(typeof e.refresh!=="function")throw Error("Observer has to support refresh()-Method");b.push(e);return this};this.notifyObservers=function(){var e=Array.prototype.slice.call(arguments);b.forEach(function(b){b.refresh.apply(b,e)});return this}}})();
(function(){var b=WoSec.MixinObservable,e=["Reset","Starting","Started","Finished","TransferingData"];WoSec.newTask=function i(j,f,g){var d=Object.create(WoSec.baseObject);b.call(d);var a="Reset",h=[];d.constructor=i;d.getID=function(){return j};d.getWorkflow=function(){return g};d.getCorrespondingTask=function(){return typeof f=="string"&&f!=""?g.getTaskByID(f):null};d.getState=function(){return a};d.getInformation=function(){return h};d.addInformation=function(a){h.push(a);this.notifyObservers(this);
return this};d.setState=function(b){if(e.indexOf(b)==-1)throw Error("Unknown state ["+b+"] given");a=b;this.notifyObservers(this);return this};d.getMemento=function(){return{state:a,information:h.slice()}};d.setMemento=function(a){this.setState(a.state);h=a.information;this.notifyObservers(this);return this};return d}})();
(function(){var b=WoSec.MixinObservable;WoSec.newTaskLane=function c(i,j){var f=Object.create(WoSec.baseObject);b.call(f);f.getTasks=function(){var b=[];i.forEach(function(c,a){b[a]=j.getTaskByID(c)});return b};f.constructor=c;f.addInformation=function(b){this.getTasks().forEach(function(c){c.addInformation(b)});this.notifyObservers();return this};return f}})();
(function(){var b=WoSec.newTask,e=WoSec.newTaskLane,c=WoSec.MixinObservable;WoSec.newWorkflow=function j(f,g,d){if(typeof f!="string")throw new TypeError("The given id is not a String");var a=Object.create(WoSec.baseObject),h={},k={};c.call(a);return WoSec.extend(a,{constructor:j,toString:function(){return"Workflow:"+this.getID()},getID:function(){return f},getTaskByID:function(c){if(!h[c]){var d;if(typeof c!="string")throw new TypeError("The given activityID is not a String");d=b(c,g[c],a);h[c]=
d;h[c].getCorrespondingTask();this.notifyObservers(this)}return h[c]},getTaskLaneByID:function(b){if(!k[b]){var c;if(typeof b!="string")throw new TypeError("The given groupID is not a String");if(!d[b])throw Error("Unknown activityGroupID["+b+"]");c=e(d[b],a);k[b]=c;this.notifyObservers(this)}return k[b]},getTaskRepositoryEntries:function(){var a=[],b;for(b in h)a.push(b);return a},getTaskLaneRepositoryEntries:function(){var a=[],b;for(b in k)a.push(b);return a}})}})();
(function(){function b(a){if(typeof a!="number")throw Error("Timestamp ["+a+"] is not a number");this.timestamp=a}function e(a,c,d){b.call(this,d);this.task=a;this.information=c;this.information.timestamp=d}function c(a,c,d){b.call(this,d);this.task=a;this.information=c||{};this.information.timestamp=d}function i(a,c,d){b.call(this,d);this.task=a;this.information=c||{};this.information.timestamp=d}function j(a,c,d){b.call(this,d);this.taskLane=a;this.information=c||{};this.information.timestamp=d;
this.taskMementos=[]}var f=WoSec.newWorkflow,g,d={state:"Reset",information:[]};b.prototype=Object.create(WoSec.baseObject);b.prototype.classname="EventCommand";b.prototype.getClass=function(){return this.classname};b.prototype.execute=function(){return this};b.prototype.unwind=function(){return this};b.prototype.getTimestamp=function(){return this.timestamp};b.create=function(a){return new b(a.timestamp)};WoSec.inherit(e,b);e.prototype.classname="StartingTaskEvent";e.prototype.execute=function(){this.task.setState("Started");
this.taskMemento=this.task.getMemento();this.task.addInformation(this.information);var a=this.task.getCorrespondingTask();if(a)this.correspondingTaskMemento=a.getMemento(),a.setState("Started"),this.task.getCorrespondingTask().addInformation(this.information);return this};e.prototype.unwind=function(){this.task.setMemento(this.taskMemento||d);var a=this.task.getCorrespondingTask();a&&a.setMemento(this.correspondingTaskMemento||d);return this};e.create=function(a){return new e(g.getTaskByID(a.activityID),
a.information,a.timestamp)};WoSec.inherit(c,b);c.prototype.classname="FinishingTaskEvent";c.prototype.execute=function(){this.task.setState("Finished");this.taskMemento=this.task.getMemento();this.task.addInformation(this.information);var a=this.task.getCorrespondingTask();if(a)this.correspondingTaskMemento=a.getMemento(),a.setState("Finished"),this.task.getCorrespondingTask().addInformation(this.information);return this};c.prototype.unwind=function(){this.task.setMemento(this.taskMemento||d);var a=
this.task.getCorrespondingTask();a&&a.setMemento(this.correspondingTaskMemento||d);return this};c.create=function(a){return new c(g.getTaskByID(a.activityID),a.information,a.timestamp)};WoSec.inherit(i,b);i.prototype.classname="TransferingDataEvent";i.prototype.execute=function(){this.task.setState("TransferingData");this.taskMemento=this.task.getMemento();this.task.addInformation(this.information);var a=this.task.getCorrespondingTask();if(a)this.correspondingTaskMemento=a.getMemento(),this.task.getCorrespondingTask().addInformation(this.information);
return this};i.prototype.unwind=function(){this.task.setMemento(this.taskMemento||d);var a=this.task.getCorrespondingTask();a&&a.setMemento(this.correspondingTaskMemento||d);return this};i.create=function(a){return new i(g.getTaskByID(a.activityID),a.information,a.timestamp)};WoSec.inherit(j,b);j.prototype.classname="SpecifyingParticipantEvent";j.prototype.execute=function(){this.taskMementos=this.taskLane.getTasks().map(function(a){return a.getMemento()});this.taskLane.addInformation(this.information);
return this};j.prototype.unwind=function(){var a=this;this.taskLane.getTasks().forEach(function(b,c){b.setMemento(a.taskMementos[c]||d)});return this};j.create=function(a){return new j(g.getTaskLaneByID(a.activityGroupID),a.information,a.timestamp)};WoSec.eventCommands={usingWorkflow:function(a){if(!a instanceof f)throw new TypeError("Given argument is not a workflow ["+a+"]");g=a;return this},EventCommand:b,StartingTask:e,FinishingTask:c,TransferingData:i,SpecifyingParticipant:j}})();
(function(){var b=WoSec.eventCommands,e=b.EventCommand,c=WoSec.MixinObservable;WoSec.newEventChain=function j(f){var g=[],d=0,a=!1,h=!1,k=Object.create(WoSec.baseObject);c.call(k);return WoSec.extend(k,{constructor:j,getWorkflow:function(){return f},getCurrentPosition:function(){return d},getEventCommand:function(a){return g[a]},getLength:function(){return g.length},lock:function(){a=!0;return this},unlock:function(){a=!1;return this},isLocked:function(){return a},add:function(a){a=a||[];a.forEach(function(a){if(!b[a.eventCommand])throw Error("Unknown EventCommand: "+
a.eventCommand);g.push(b.usingWorkflow(f)[a.eventCommand].create(a))});this.notifyObservers(this,"add");!this.isLocked()&&d>0&&(d++,this.notifyObservers(this,"position"));return this},seek:function(a,b){for(var c=b?-1:1,e=d;0<=e&&e<g.length;){d=e;if(a(g[e],e)===!1)break;this.notifyObservers(this,"position");e+=c}return this},forEach:g.forEach.bind(g),play:function(){if(h)return this;if(a)return this;h=!0;var b=0;this.seek(function(a){a.later(b,"execute");b+=1E3});setTimeout(function(){h=!1},b);this.later(b,
"play");return this},last:function(){return g[g.length-1]?g[g.length-1]:new e(0)}})}})();
WoSec.AJAXUpdater=function(b,e,c){function i(a){f.getJSON(j,{since:b.last().getTimestamp()+1,instance:b.getWorkflow().getID()},a)}var j="UpdateController?type=Event",f=jQuery,g=0,e=e||0;i(function(a){a.length!=0&&(c.disableAnimations(b),b.add(a).seek(function(a){return a.getTimestamp()<=e&&a.execute()}),c.enableAnimations(b),b.play())});var d=function(a){a.length!=0&&b.add(a).play();setTimeout(i,5E3,d)};setTimeout(i,5E3,d);f("body").ajaxError(function(){g++;g>=3?alert("Verbindung zum Server verloren!"):
setTimeout(i,5E3,d)})};

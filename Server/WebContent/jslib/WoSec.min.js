var WoSec={baseObject:{later:function(b,d){var c=this,i=Array.prototype.slice.apply(arguments,[2]);typeof d==="string"&&(d=c[d]);setTimeout(function(){d.apply(c,i)},b);return c}},inherit:function(b,d){var c=Object.create(d.prototype);c.constructor=b;b.prototype=c},extend:function(b,d){for(var c in d)d.hasOwnProperty(c)&&(b[c]=d[c]);return b}};(function(){var b=jQuery;WoSec.SVG=function(d){this.$svg=b("#"+d)}})();
(function(){function b(b,f){return b.find("svg rect").filter(function(){return c(this).attr(i)==f})}function d(b,f){return b.find("svg circle").filter(function(){return c(this).attr(i)==f})}var c=jQuery,i="bpmn:activity-id",j={};WoSec.SVG.prototype.getTaskRectangle=function(b){j[b]||(j[b]=this.newTaskRectangle(b));return j[b]};WoSec.SVG.prototype.newTaskRectangle=function(g){var f=this.$svg,a=b(f,g);a.length||(a=d(f,g));if(a.length==0)throw Error("No rectangles/circles with activityID:["+g+"] found");
var e=Object.create(WoSec.baseObject),h=!0;e.disableAnimations=function(){h=!1;return this};e.enableAnimations=function(){h=!0;return this};e.scrollTo=function(){var a=this.getPosition(),b=a.x-f.parent().width()/2,a=a.y-f.parent().height()/2,c=f.scrollLeft(),e=f.scrollTop();if(Math.abs(b-c)>100||Math.abs(a-e)>100)f.animate({scrollLeft:b},100),f.animate({scrollTop:a},100);return this};e.refresh=function(a){switch(a.getState()){case "Reset":this.reset();break;case "Started":this.markObtrusive();this.scrollTo();
h&&this.highlight();break;case "Finished":this.markUnobtrusive(),this.scrollTo()}};e.getPosition=function(){return{x:parseInt(c(a[0]).attr("x")),y:parseInt(c(a[0]).attr("y")),width:parseInt(c(a[0]).attr("width")),height:parseInt(c(a[0]).attr("height")),getCenter:function(){return{x:this.x+this.width/2,y:this.y+this.height/2}}}};var l=f.find("svg text").filter(function(){var a=e.getPosition();return Math.abs(parseInt(c(this).attr("x"))-a.x)<a.width&&Math.abs(parseInt(c(this).attr("y"))-a.y)<a.height});
e.highlight=function(){a.each(function(){c(this).effect("pulsate",{times:3},1E3)});return this};e.markObtrusive=function(){a.each(function(){var a=c("#rect-obtrusive").css("color");c(this).attr("fill",a);c(this).css("fill",a)});return this};e.markUnobtrusive=function(){a.each(function(){var a=c("#rect-unobtrusive").css("color");c(this).attr("fill",a);c(this).css("fill",a)});return this};e.reset=function(){a.each(function(){var a=c("#rect-reset").css("color");c(this).attr("fill",a);c(this).css("fill",
a)});return this};e.registerOnClick=function(b){c(a[0]).click(b);l.each(function(){c(this).click(b)});return this};e.registerOnHover=function(b){c(a[0]).hover(b);l.each(function(){c(this).hover(b)});return this};e.getOtherWorkflowID=function(){var b;a.each(function(){var a=c(this).attr("bpmn:other-workflow");a&&(b=a)});return b};return e}})();
(function(){function b(b,i){return b.find("svg rect").filter(function(){return d(this).attr("bpmn:pool-id")==i})}var d=jQuery;WoSec.SVG.prototype.newTaskLaneRectangle=function(c){var i=b(this.$svg,c),c=Object.create(WoSec.baseObject),j=!0;c.disableAnimations=function(){j=!1;return this};c.enableAnimations=function(){j=!0;return this};c.highlight=function(){i.each(function(){d(this).effect("pulsate",{times:1},1E3)})};c.refresh=function(){j&&this.highlight()};return c}})();
(function(){var b,d,c=jQuery;b=25.5;d=33;var i;WoSec.SVG.prototype.newDataAnimation=function(j,g,f){function a(a){a.x-=b/2;a.y-=d/2;return a}var g=a(g),f=a(f),e=Object.create(WoSec.baseObject),h=this.$svg;i||(i=document.createElementNS("http://www.w3.org/2000/svg","image"),i.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","media/images/fileicon.png"),i.setAttribute("width",b),i.setAttribute("height",d));var l=i.cloneNode(!0);l.setAttribute("id",j);h.find("svg")[0].appendChild(l);var k=
c("#"+j);k.hide();k.attr("x",g.x);k.attr("y",g.y);var m=!0;e.disableAnimations=function(){m=!1;return this};e.enableAnimations=function(){m=!0;return this};e.show=function(){k.show();k.animate({svgY:f.y},1E3,function(){k.hide();k.attr("y",g.y)});return this};e.refresh=function(a){switch(a.getState()){case "TransferingData":m&&this.show()}};return e}})();
(function(){var b=jQuery,d=WoSec.SVG,c="infoboxes",i="svg",j="workflow-link",g="current-workflow",f=2E3;WoSec.HTMLGUI=function(a){function e(c){b("."+i).each(function(){b(this).hide()});b("."+j).each(function(){b(this).removeClass(g);b(this).attr("href").substr(1)===c&&b(this).addClass(g)});b("#"+c).show();o[c].addClass(g);a.forEach(function(a){a.getWorkflow().getID()!==c&&a.lock()})}function h(a){for(var d=a.getID(),g=a.getTaskRepositoryEntries(),h,j=g.length-1;j>=0;j--)if(h=g[j],!(q[d].indexOf(h)>
-1)){var i=a.getTaskByID(h),n=k[d].newTaskRectangle(h);i.registerObserver(n);var p=n.getOtherWorkflowID();p&&i.registerObserver(function(a){return{refresh:function(b){b.getState()==="TransferingData"&&setTimeout(function(){e(a)},f)}}}(p));var o;i.getCorrespondingTask()&&(o=k[d].newDataAnimation(h,n.getPosition().getCenter(),k[d].getTaskRectangle(i.getCorrespondingTask().getID()).getPosition().getCenter()),i.registerObserver(o));h=l.newInfobox(n.getPosition());i.registerObserver(h);n.registerOnHover(h.show);
h.appendTo(b("#"+d).find("."+c));m[d].push(n);o&&m[d].push(o)}q[d]=g}var l=this,k={},m={},q={},p={},n=[];this.refresh=function(a){h(a);for(var b=a.getID(),c=a.getTaskLaneRepositoryEntries(),e,f=c.length-1;f>=0;f--)if(e=c[f],!(p[b].indexOf(e)>-1)){var d=k[b].newTaskLaneRectangle(e);a.getTaskLaneByID(e).registerObserver(d);m[b].push(d)}p[b]=c;return this};a.forEach(function(a){var a=a.getWorkflow(),b=a.getID();n.push(b);a.registerObserver(l)});b("."+i).each(function(){var a=b(this).attr("id");if(n.indexOf(a)===
-1)throw Error("Unknown workflowID["+a+"]");k[a]=new d(a);m[a]=[];q[a]=[];p[a]=[]});var o={};b("."+j).each(function(){var a=b(this).attr("href").substr(1);o[a]=b(this);if(n.indexOf(a)===-1)throw Error("Unknown workflowID["+a+"]");b(this).click(function(){e(b(this).attr("href").substr(1))})});e(a[0].getWorkflow().getID());this.disableAnimations=function(a){m[a.getWorkflow().getID()].forEach(function(a){a.disableAnimations()});return this};this.enableAnimations=function(a){m[a.getWorkflow().getID()].forEach(function(a){a.enableAnimations()});
return this};b("."+i).dragscrollable({dragSelector:".dragger:first",acceptPropagatedEvent:!0})}})();
(function(){var b=jQuery,d,c,i;WoSec.HTMLGUI.prototype.newInfobox=function(j){d||(d=b("<div class=\"infobox\"><span class='infobox-pin-button'>#</span></div>").hide());var g=d.clone(),f=!0;g.css("top",j.y+j.height);g.css("left",j.x+j.width);var a=!1,e=!1;g.find(".infobox-pin-button").click(function(){e?h.unpin():h.pin()});var h=Object.create(WoSec.baseObject);return WoSec.extend(h,{refresh:function(a){this.setContent(a.getInformation(),a)},show:function(){!a&&!f&&(g.slideToggle("slow"),a=!0,h.later(3E3,
"hide"));return this},hide:function(){a&&!e&&(g.slideToggle("slow"),a=!1);return this},pin:function(){e=!0;h.show();return this},unpin:function(){e=!1;h.hide();return this},setContent:function(a,e){g.find(".infobox-entry").remove();a.forEach(function(a){c||(c=b('<div class="infobox-entry"><span class="infobox-entry-header"><span class="infobox-entry-time"></span><span class="infobox-entry-execUser"></span></span><div class="infobox-entry-content"><span class="infobox-entry-evokUser"></span><span class="infobox-entry-provider"></span><span class="infobox-entry-data"></span><ul class="infobox-entry-attachments"></ul><span class="infobox-entry-usageReason"></span></div></div>'));
var d=c.clone(),h=new Date(a.timestamp*1E3);d.find(".infobox-entry-time").text(h.getDate()+"."+h.getMonth()+"."+h.getFullYear());a.participants&&(d.find(".infobox-entry-execUser").text(a.participants.execUser),d.find(".infobox-entry-evokUser").text(a.participants.evokUser),d.find(".infobox-entry-provider").text(a.participants.provider),f=!1);d.find(".infobox-entry-data").text(a.data);if(a.attachments){var j=d.find(".infobox-entry-attachments");a.attachments.forEach(function(a){i||(i=b('<li class="infobox-attachment-entry"><span class="infobox-attachment-entry-name"></span><a></a></li>'));
var c=i.clone();c.find(".infobox-attachment-entry-name").text(a.name);c.find("a").attr("href",a.link).text(a.type);j.append(c)});f=!1}d.find(".infobox-entry-usageReason").text(a.usageReason);a.fromTask===e.getID()&&a.fromWorkflow===e.getWorkflow().getID()?d.addClass("infobox-entry-outgoing"):d.addClass("infobox-entry-incoming");g.append(d)});return this},registerOnClick:function(a){g.click(a);return this},registerOnHover:function(a,b){g.hover(a,b);return this},appendTo:function(a){g.appendTo(a);return this}})}})();
(function(){var b=jQuery,d;WoSec.HTMLGUI.prototype.newTimeSlider=function(c,i){b("#timeslider-play-button").click(function(){c.enableAnimations();i.unlock().play()});var j=[],g=b("#timeslider").slider({slide:function(b,a){var e=g.slider("option","value"),d=a.value<e,l;j.forEach(function(b){if(b.timestamp<=a.value)l=b.eventCommand});c.disableAnimations(i);i.lock().seek(function(a){d?a.unwind():a.execute();if(a==l)return!1},d)}});return{adjustSize:function(c){var a,e,h=g.slider("option","min"),i=g.slider("option",
"max"),k=!1;c.forEach(function(c,f){if(!j[f]){var h={};h.eventCommand=c;h.timestamp=c.getTimestamp();d||(d=b('<a class="timeslider-entry"></a>'));h.entry=d.clone().appendTo("#timeslider");h.entry.addClass("timeslider-entry-"+c.getClass());j.push(h)}h=c.getTimestamp();if(!a||h<a)a=h;if(!e||h>e)e=h;a&&(g.slider("option","min",a),k=!0);e&&(g.slider("option","max",e),k=!0)});a==h&&e==i&&(k=!1);if(k){var m=e-a;j.forEach(function(a){rightPercent=(e-a.timestamp)/m*100;a.entry.css("left",100-rightPercent+
"%")})}return this},refresh:function(c){c.getLength()!=j.length&&(this.adjustSize(c),c.isLocked()&&(b("#timeslider-play-button-overlay").show(),b("#timeslider-play-button").effect("pulsate",{times:10},1E3),setTimeout(function(){b("#timeslider-play-button-overlay").hide()},1E4)));g.slider("option","value",c.getEventCommand(c.getCurrentPosition()).getTimestamp());return this}}}})();
(function(){WoSec.MixinObservable=function(){var b=[];this.registerObserver=function(d){if(typeof d.refresh!=="function")throw Error("Observer has to support refresh()-Method");b.push(d);return this};this.notifyObservers=function(){var d=Array.prototype.slice.call(arguments);b.forEach(function(b){b.refresh.apply(b,d)});return this}}})();
(function(){var b=WoSec.MixinObservable,d=["Reset","Starting","Started","Finished","TransferingData"];WoSec.newTask=function i(j,g,f){var a=Object.create(WoSec.baseObject);b.call(a);var e="Reset",h=[];a.constructor=i;a.getID=function(){return j};a.getWorkflow=function(){return f};a.getCorrespondingTask=function(){return typeof g=="string"&&g!=""?f.getTaskByID(g):null};a.getState=function(){return e};a.getInformation=function(){return h};a.addInformation=function(a){h.push(a);this.notifyObservers(this);
return this};a.setState=function(a){if(d.indexOf(a)==-1)throw Error("Unknown state ["+a+"] given");e=a;this.notifyObservers(this);return this};a.getMemento=function(){return{state:e,information:h}};a.setMemento=function(a){this.setState(a.state);h=a.information;this.notifyObservers(this);return this};return a}})();
(function(){var b=WoSec.MixinObservable;WoSec.newTaskLane=function c(i,j){var g=Object.create(WoSec.baseObject);b.call(g);g.getTasks=function(){var b=[];i.forEach(function(a,c){b[c]=j.getTaskByID(a)});return b};g.constructor=c;g.addInformation=function(b){this.getTasks().forEach(function(a){a.addInformation(b)});this.notifyObservers();return this};return g}})();
(function(){var b=WoSec.newTask,d=WoSec.newTaskLane,c=WoSec.MixinObservable;WoSec.newWorkflow=function j(g,f,a){if(typeof g!="string")throw new TypeError("The given id is not a String");var e=Object.create(WoSec.baseObject),h={},l={};c.call(e);return WoSec.extend(e,{constructor:j,toString:function(){return"Workflow:"+this.getID()},getID:function(){return g},getTaskByID:function(a){if(!h[a]){var c;if(typeof a!="string")throw new TypeError("The given activityID is not a String");c=b(a,f[a],e);h[a]=
c;h[a].getCorrespondingTask();this.notifyObservers(this)}return h[a]},getTaskLaneByID:function(b){if(!l[b]){var c;if(typeof b!="string")throw new TypeError("The given groupID is not a String");if(!a[b])throw Error("Unknown activityGroupID["+b+"]");c=d(a[b],e);l[b]=c;this.notifyObservers(this)}return l[b]},getTaskRepositoryEntries:function(){var a=[],b;for(b in h)a.push(b);return a},getTaskLaneRepositoryEntries:function(){var a=[],b;for(b in l)a.push(b);return a}})}})();
(function(){function b(a){if(typeof a!="number")throw Error("Timestamp ["+a+"] is not a number");this.timestamp=a}function d(a,c,d){b.call(this,d);this.task=a;this.information=c;this.information.timestamp=d}function c(a,c,d){b.call(this,d);this.task=a;this.information=c||{};this.information.timestamp=d}function i(a,c,d){b.call(this,d);this.task=a;this.information=c||{};this.information.timestamp=d}function j(a,c,d){b.call(this,d);this.taskLane=a;this.information=c||{};this.information.timestamp=d}
var g=WoSec.newWorkflow,f;b.prototype=Object.create(WoSec.baseObject);b.prototype.classname="EventCommand";b.prototype.getClass=function(){return this.classname};b.prototype.execute=function(){return this};b.prototype.unwind=function(){return this};b.prototype.getTimestamp=function(){return this.timestamp};b.create=function(a){return new b(a.timestamp)};WoSec.inherit(d,b);d.prototype.classname="StartingTaskEvent";d.prototype.execute=function(){this.task.setState("Started");this.taskMemento=this.task.getMemento();
this.task.addInformation(this.information);var a=this.task.getCorrespondingTask();if(a)this.correspondingTaskMemento=a.getMemento(),a.setState("Started"),this.task.getCorrespondingTask().addInformation(this.information);return this};d.prototype.unwind=function(){this.task.setMemento(this.taskMemento);var a=this.task.getCorrespondingTask();a&&a.setMemento(this.correspondingTaskMemento);return this};d.create=function(a){return new d(f.getTaskByID(a.activityID),a.information,a.timestamp)};WoSec.inherit(c,
b);c.prototype.classname="FinishingTaskEvent";c.prototype.execute=function(){this.task.setState("Finished");this.taskMemento=this.task.getMemento();this.task.addInformation(this.information);var a=this.task.getCorrespondingTask();if(a)this.correspondingTaskMemento=a.getMemento(),a.setState("Finished"),this.task.getCorrespondingTask().addInformation(this.information);return this};c.prototype.unwind=function(){this.task.setMemento(this.taskMemento);var a=this.task.getCorrespondingTask();a&&a.setMemento(this.correspondingTaskMemento);
return this};c.create=function(a){return new c(f.getTaskByID(a.activityID),a.information,a.timestamp)};WoSec.inherit(i,b);i.prototype.classname="TransferingDataEvent";i.prototype.execute=function(){this.task.setState("TransferingData");this.taskMemento=this.task.getMemento();this.task.addInformation(this.information);var a=this.task.getCorrespondingTask();if(a)this.correspondingTaskMemento=a.getMemento(),this.task.getCorrespondingTask().addInformation(this.information);return this};i.prototype.unwind=
function(){this.task.setMemento(this.taskMemento);var a=this.task.getCorrespondingTask();a&&a.setMemento(this.correspondingTaskMemento);return this};i.create=function(a){return new i(f.getTaskByID(a.activityID),a.information,a.timestamp)};WoSec.inherit(j,b);j.prototype.classname="SpecifyingParticipantEvent";j.prototype.execute=function(){this.taskMementos=this.taskLane.getTasks().map(function(a){return a.getMemento()});this.taskLane.addInformation(this.information);return this};j.prototype.unwind=
function(){this.taskLane.getTasks().forEach(function(a,b){a.setMemento(this.taskMementos[b])});return this};j.create=function(a){return new j(f.getTaskLaneByID(a.activityGroupID),a.information,a.timestamp)};WoSec.eventCommands={usingWorkflow:function(a){if(!a instanceof g)throw new TypeError("Given argument is not a workflow ["+a+"]");f=a;return this},EventCommand:b,StartingTask:d,FinishingTask:c,TransferingData:i,SpecifyingParticipant:j}})();
(function(){var b=WoSec.eventCommands,d=b.EventCommand,c=WoSec.MixinObservable;WoSec.newEventChain=function j(g){var f=[],a=0,e=!1,h=Object.create(WoSec.baseObject);c.call(h);return WoSec.extend(h,{constructor:j,getWorkflow:function(){return g},getCurrentPosition:function(){return a},getEventCommand:function(a){return f[a]},getLength:function(){return f.length},lock:function(){e=!0;return this},unlock:function(){e=!1;return this},isLocked:function(){return e},add:function(a){a=a||[];a.forEach(function(a){if(!b[a.eventCommand])throw Error("Unknown EventCommand: "+
a.eventCommand);f.push(b.usingWorkflow(g)[a.eventCommand].create(a))});f.sort(function(){});this.notifyObservers(this);return this},seek:function(b,c){var d=c?-1:1,e=a;for(e==f.length&&e--;0<=e&&e<f.length;){a=e;if(b(f[e],e)===!1)break;e+=d}this.notifyObservers(this);return this},forEach:f.forEach.bind(f),play:function(){if(e)return this;var b=0;this.seek(function(a){a.later(b,"execute");b+=1E3});setTimeout(function(){a=f.length},b);return this},last:function(){return f[f.length-1]?f[f.length-1]:
new d(0)}})}})();WoSec.AJAXUpdater=function(b,d){function c(a){j.getJSON(i,{since:b.last().getTimestamp()+1,instance:b.getWorkflow().getID()},a)}var i="UpdateController?type=Event",j=jQuery,g=0,d=d||0;c(function(a){a.length!=0&&b.add(a).seek(function(a){return a.getTimestamp()<=d&&a.execute()}).play()});var f=function(a){a.length!=0&&b.add(a).play();setTimeout(c,5E3,f)};setTimeout(c,5E3,f);j("body").ajaxError(function(){g++;g>=3?alert("Verbindung zum Server verloren!"):setTimeout(c,5E3,f)})};
